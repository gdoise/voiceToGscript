<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Assistant Vocal Google Sheet Configurable</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #status-container { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
        #recognized-text-display { font-weight: bold; color: #007bff; }
        #parametre-input { width: 400px; padding: 8px; margin-top: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Assistant Vocal Google Sheet br synonym v2.7 OK avant implement de GetLatestGScriptID</h1>

    <div id="status-container">
        <p>Statut du Système: <span id="status">Initialisation...</span></p>
        <p>Mode Actuel: <span id="mode-display">auto</span></p>
        <p>Paramètre Global (pour mode indirect): <span id="parametre-display">Non défini</span></p>
    </div>

    <p>Vous avez dit: <span id="recognized-text-display">...</span></p>

    <fieldset>
        <legend>Correction / Saisie Manuelle</legend>
        <input type="text" id="parametre-input" placeholder="Tapez un paramètre ou une commande..." />
        <button id="set-param-button">Définir Paramètre</button>
        <button id="run-command-button">Exécuter Commande Manuelle</button>
    </fieldset>
    
    <button id="start-button">Démarrer l'écoute</button>
    <button id="stop-button" disabled>Arrêter l'écoute</button>
    <h3>Journal client</h3>
    <textarea id="client-log" style="width:100%;height:200px;font-size:12px;"></textarea>
    
    <script>
        // // _ Définition des constantes et des variables globales
        //on ira le chercher sur GetLatestGScriptID   https://docs.google.com/spreadsheets/d/1rXN5MojlxvFxKcy9QScEZ_wAxEDLANgBmlJ3HoyzIPg/edit?gid=0#gid=0
        const BASE_URL = 'AKfycbwk7nUiulWZ51CQVobo3oMhifJPHS0JnvjV_CIDR_oYsTCwBzCT79q6ei8EVT1VcyKI/exec';
        // // _ Ceci est un DEPLOY_ID de démo. À REMPLACER par votre ID réel de Apps Script (celui du arrMySheet[0][1]).
        
        let mode = "auto";
        let parametre = "";
        let commandsData = []; // La liste des commandes sera chargée dynamiquement.
        let recognition = null; // Objet pour la reconnaissance vocale

        // // _ Références aux éléments du DOM
        const statusEl = document.getElementById('status');
        const modeDisplayEl = document.getElementById('mode-display');
        const paramDisplayEl = document.getElementById('parametre-display');
        const recognizedTextEl = document.getElementById('recognized-text-display');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const paramInput = document.getElementById('parametre-input');
        const setParamButton = document.getElementById('set-param-button');
        const runCommandButton = document.getElementById('run-command-button');

        let lastCommand = {
            action: "",
            param: "",
            time: 0
        };


        // ________________________DEF__(Fonctions Utilitaires)___________________
        
        function logClient(msg) {
            const logArea = document.getElementById("client-log");
            if (logArea) {
                const t = new Date().toLocaleTimeString();
                logArea.value += `[${t}] ${msg}\n`;
                logArea.scrollTop = logArea.scrollHeight;
            }
        }
        
        /**
         * Fonction: dire
         * Rôle: Utilise la synthèse vocale pour prononcer un texte.
         * Usage: dire("Bonjour");
         */
        function dire(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            window.speechSynthesis.speak(utterance);
        }

        /**
         * Fonction: noAccents
         * Rôle: Supprime les accents, la ponctuation et met en minuscules.
         * Usage: const sansAccent = noAccents("Liste Pénélope.");
         */
        function noAccents(strIn) {
            // Normalise et supprime les accents, puis retire la ponctuation et les symboles non-lettres/chiffres
            let normalized = strIn.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalized = normalized.replace(/[^a-zA-Z0-9\s]/g, ""); // Retire ponctuation
            return normalized.toLowerCase().trim();
        }

        /**
         * Fonction: updateDisplay
         * Rôle: Met à jour l'affichage des informations clés (mode, paramètre, statut).
         */
        function updateDisplay(newStatus = null) {
            if (newStatus) {
                statusEl.textContent = newStatus;
            }
            modeDisplayEl.textContent = mode;
            paramDisplayEl.textContent = parametre ? parametre : "Non défini";
        }

        /**
         * Fonction: loadConfig
         * Rôle: Télécharge la liste des commandes et la configuration depuis Apps Script.
         */
        async function loadConfig() {
            updateDisplay("Chargement de la configuration...");
            
            try {
                // BLOC DE DONNÉES EN DUR (Assurer le succès)
                // -----------------------------------------------------------------------------------
                commandsData = [ 
                    {"baseWords": ["liste", "list"], "comandGet": "listAllocine","echec":"paramètre ?"}, 
                    {"baseWords": ["choisis", "choisi", "choisit"], "comandGet": "choixAllocine","echec":"paramètre ?"},
                    {"baseWords": "cherche exact", "comandGet": "findExact","echec":"paramètre ?"},
                    {"baseWords": "cherche", "comandGet": "find","echec":"paramètre ?"},
                    {"baseWords": "quit", "comandGet": "Quitter","echec":"paramètre ?"},
                    {"baseWords": "identifiant", "comandGet": "goWSheetIdRow","echec":"paramètre ?"},
                    {"baseWords": "allocine", "comandGet": "allocine","echec":"paramètre ?"},
                    {"baseWords": "selectionne", "comandGet": "SelectIdRow","echec":"paramètre ?"},
                    {"baseWords": "affiche ajuste", "comandGet": "affiche_MAJ","echec":"paramètre ?"},
                    {"baseWords": "affiche ajoute", "comandGet": "affiche_ADD","echec":"paramètre ?"},
                    {"baseWords": "affiche enleve", "comandGet": "affiche_SUB","echec":"paramètre ?"},
                    {"baseWords": "affichette ajute", "comandGet": "affichette_MAJ","echec":"paramètre ?"},
                    {"baseWords": "affichette ajoute", "comandGet": "affichette_ADD","echec":"paramètre ?"},
                    {"baseWords": "affichette enleve", "comandGet": "affichette_SUB","echec":"paramètre ?"}
                ]; 
                
                // -----------------------------------------------------------------------------------

                // NOUVEAU CHECK VISUEL : Ajout d'une classe pour rendre le statut vert
                statusEl.classList.add('success');
                console.log("SUCCESS: Configuration des commandes en dur chargée."); // Vérification Console
                
                updateDisplay("Configuration chargée. Prêt. (Vérifiez si l'affichage est vert)");
                
                // Tente toujours de parler
                dire("Configuration chargée. Prêt."); 
                startButton.disabled = false;

            } catch (error) {
                console.error("Erreur de chargement de la config:", error);
                statusEl.classList.remove('success');
                statusEl.classList.add('error');
                updateDisplay("Erreur: Échec du chargement de la configuration.");
                dire("Erreur: Échec du chargement de la configuration.");
            }
        }
        
        // ________________________DEF__(Fonctions d'Action)___________________

        /**
         * Fonction: sendCommand
         * Rôle: Envoie la commande et le paramètre à Google Apps Script via fetch.
         * Usage: sendCommand("listAllocine", "penelope");
         */
        async function sendCommand(action, param1) {
            // // _ La conversion noAccents n'est pas nécessaire ici, car param1 est déjà traité par processCommand/paramInput.
            const url = `${BASE_URL}?action=${action}&param1=${encodeURIComponent(param1)}`;
            console.log(`Envoi de la commande: ${url}`);
            
            const oldStatus = statusEl.textContent;
            statusEl.textContent = `Envoi de ${action}...`;

            try {
                const response = await fetch(url);
                const textResponse = await response.text();
                
                if (response.ok) {
                    console.log("Réponse Apps Script: ", textResponse);
                    recognizedTextEl.innerHTML = `<span class="success">Réussite: ${textResponse.substring(0, 100)}...</span>`;
                    dire(`Action ${action} terminée.`); 
                } else {
                    console.error(`Erreur HTTP: ${response.status}: ${textResponse}`);
                    recognizedTextEl.innerHTML = `<span class="error">Échec: ${response.status}</span>`;
                    dire(`Échec de la commande ${action}.`);
                }
            } catch (error) {
                console.error("Erreur de connexion Apps Script: ", error);
                recognizedTextEl.innerHTML = `<span class="error">Erreur de connexion</span>`;
                dire("Erreur de connexion.");
            } finally {
                updateDisplay(oldStatus);
            }
        }

        // ________________________DEF__(Logique Commande)___________________

        /**
         * Fonction: processCommand
         * Rôle: Gère la logique de la commande vocale (modes, paramètres, exécution).
         * Usage: processCommand("cherche exact titanic");
         */
        function processCommand(phraseBrute) {
            logClient("-192 processCommand() → phrase brute: " + phraseBrute);
            let phrase = noAccents(phraseBrute);
            logClient("-194 processCommand() → normalisé: " + phrase);
            console.log('SAID (Normalisé):' + phrase);
            recognizedTextEl.textContent = phraseBrute;

            // 1. GESTION DES COMMANDES INTERNES (Mode, Paramètre)
            
            // a. Gestion du Mode
            if (phrase.includes("mode")) {
                let newMode = phrase.includes("direct") ? "direct" :
                              phrase.includes("indirect") ? "indirect" :
                              phrase.includes("auto") ? "auto" : null;
                if (newMode) {
                    mode = newMode;
                    updateDisplay(`Mode changé en ${mode}`);
                    dire(`Mode ${mode}`);
                    return;
                }
            }

            // b. Gestion du Paramètre (pour le mode indirect)
            if (phrase.includes("parametre egal") || phrase.includes("parametre =")) {
                // Recherche tout ce qui vient après le mot "égal" ou "="
                const match = phraseBrute.match(/egal\s*(.*)|=\s*(.*)/);
                if (match && (match[1] || match[2])) {
                    parametre = match[1] ? match[1].trim() : match[2].trim(); // Garde les accents dans le paramètre !
                    updateDisplay(`Paramètre global défini.`);
                    dire(`Paramètre défini: ${parametre}`);
                    return;
                }
            }

            // 2. RECHERCHE ET EXÉCUTION DE LA COMMANDE APPS SCRIPT
            for (const item of commandsData) {
                logClient("-227 Test commande: " + JSON.stringify(item));
                // --- NOUVEAU : itère sur tous les synonymes ---
                let commandFound = false;
                let matchedWord = "";
                
                const synList = Array.isArray(item.baseWords) ? item.baseWords : [];
                logClient("→ Synonymes analysés: " + JSON.stringify(synList));

                for (const syn of synList) { //(const syn of item.baseWords) 
                    let synNorm = noAccents(syn).trim();
                    if (synNorm && phrase.includes(synNorm)) {
                        commandFound = true;
                        matchedWord = synNorm;
                        break;
                    }
                }
            
                if (commandFound) {
                    logClient("-242 => Commande reconnue grâce au synonyme: '" + matchedWord + "'");
                    let getAction = item.comandGet;
                    let getParam1 = "";
            
                    // Quitter (inchangé)
                    if (getAction === "Quitter") {
                        dire("Au revoir !");
                        recognition.stop();
                        return;
                    }
            
                    // --- NOUVEAU : extraction param basée sur le synonyme réellement trouvé ---
                    const indexAfter = phrase.indexOf(matchedWord) + matchedWord.length;
                    let paramVoc = phraseBrute.substring(indexAfter).trim();
            
                    const paramIsProvided = paramVoc !== "";
                    logClient("-258 Param extrait: '" + paramVoc + "'  | Paramètre global=" + parametre);
                    if (mode === "auto") {
                        getParam1 = paramIsProvided ? paramVoc : parametre;
                    } else if (mode === "indirect") {
                        getParam1 = parametre;
                    } else if (mode === "direct" && paramIsProvided) {
                        getParam1 = paramVoc;
                    }
            
                    // Final
                    if (getParam1) {
                        logClient("-269 Envoi à Apps Script: action=" + getAction + " param1=" + getParam1);
                        // Anti-répétition : bloque les doublons rapprochés
                        const now = Date.now();
                        if (
                            lastCommand.action === getAction &&
                            lastCommand.param === getParam1 &&
                            (now - lastCommand.time) < 1200       // 1.2 seconde
                        ) {
                            logClient("⚠️ Commande ignorée (doublon rapproché) : action=" + getAction + " param=" + getParam1);
                            return;
                        }
                        
                        // Mise à jour mémoire anti-doublon
                        lastCommand.action = getAction;
                        lastCommand.param = getParam1;
                        lastCommand.time = now;
                        sendCommand(getAction, getParam1);
                        return;
                    } else {
                        logClient("-273 Paramètre manquant → item.echec=" + item.echec);
                        dire(`Veuillez spécifier un ${item.echec}`);
                        return;
                    }
                }
            }                

            // Si aucune commande reconnue
            if (!phrase.includes("mode") && !phrase.includes("parametre")) {
                 logClient("-282 Aucune commande reconnue pour cette phrase.");
                 dire("Commande non reconnue.");
            }
        }

        // ________________________DEF__(Reconnaissance Vocale)___________________

        /**
         * Fonction: startSpeechRecognition
         * Rôle: Initialise et gère l'écoute vocale.
         */
        function startSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                dire("Désolé, votre navigateur ne supporte pas la reconnaissance vocale.");
                updateDisplay("Non supporté.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = false; // Reconnaissance phrase par phrase
            recognition.interimResults = true;   // ou false pour n'afficher que le texte finalement reconnu

            recognition.onstart = () => {
                startButton.disabled = true;
                stopButton.disabled = false;
                updateDisplay("En écoute... Parlez.");
                console.log("Reconnaissance vocale démarrée.");
            };

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                let phrase = event.results[last][0].transcript;
                processCommand(phrase);
            };

            recognition.onerror = (event) => {
                console.error('Erreur de reconnaissance vocale:', event.error);
                let errorMessage = "Erreur inconnue.";
                
                // Mettre à jour le statut et le message d'erreur
                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    errorMessage = "Accès microphone refusé. (Autorisation nécessaire).";
                    // Erreur critique : on n'essaie pas de redémarrer
                    stopButton.disabled = true;
                    startButton.disabled = false;
                } else if (event.error === 'no-speech') {
                    errorMessage = "Rien entendu. (Parlez plus fort ou plus près).";
                } else if (event.error === 'audio-capture') {
                    errorMessage = "Erreur de capture audio. (Micro occupé ?).";
                } else if (event.error === 'network') {
                    errorMessage = "Erreur réseau. (Connexion instable ?).";
                }
                updateDisplay(errorMessage);

                // Si ce n'est pas une erreur de permission, on peut laisser le onend redémarrer l'écoute
                // ou forcer un redémarrage si l'écoute est continue.
                // Dans notre cas (continuous=false), le onend va se charger de relancer,
                // sauf si l'erreur est critique (permission).
            };

            recognition.onend = () => {
                if (stopButton.disabled === false) {
                     // Si l'écoute n'a pas été stoppée manuellement, on relance
                    recognition.start();
                } else {
                    updateDisplay("Prêt.");
                }
            };
            
            recognition.start();
            dire("Je vous écoute.");
        }

        // ________________________MAIN___________________

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialisation
            loadConfig(); 
            
            // Normalisation universelle : convertit toutes les commandes en listes de mots-clés
            commandsData = commandsData.map(cmd => {
                let bw = cmd.baseWords;
            
                // Si baseWords est une string → split
                if (typeof bw === "string") {
                    bw = bw.split(",").map(s => s.trim()).filter(s => s !== "");
                }
            
                // Si c'était déjà un tableau → ok
                cmd.baseWords = bw;
            
                return cmd;
            });
            
            logClient("Commandes normalisées: " + JSON.stringify(commandsData));


            // 2. Événements pour la reconnaissance vocale
            startButton.addEventListener('click', startSpeechRecognition);
            stopButton.addEventListener('click', () => {
                if (recognition) {
                    recognition.stop();
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    updateDisplay("Écoute arrêtée.");
                }
            });

            // 3. Événements pour la saisie manuelle (Correction)
            setParamButton.addEventListener('click', () => {
                const newParam = paramInput.value.trim();
                if (newParam) {
                    parametre = newParam;
                    updateDisplay("Paramètre global mis à jour manuellement.");
                    paramInput.value = "";
                    dire("Paramètre mis à jour.");
                }
            });

            // 4. Exécution manuelle d'une commande complète
            runCommandButton.addEventListener('click', () => {
                const manualCommand = paramInput.value.trim();
                if (manualCommand) {
                    processCommand(manualCommand);
                    paramInput.value = "";
                }
            });
        });
    </script>
</body>
</html>
