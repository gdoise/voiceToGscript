<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Assistant Vocal Google Sheet Configurable</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #status-container { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
        #recognized-text-display { font-weight: bold; color: #007bff; }
        #parametre-input { width: 400px; padding: 8px; margin-top: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Assistant Vocal Google Sheet v1.3 Synonymes en dur</h1>

    <div id="status-container">
        <p>Statut du Système: <span id="status">Initialisation...</span></p>
        <p>Mode Actuel: <span id="mode-display">auto</span></p>
        <p>Paramètre Global (pour mode indirect): <span id="parametre-display">Non défini</span></p>
    </div>

    <p>Vous avez dit: <span id="recognized-text-display">...</span></p>

    <fieldset>
        <legend>Correction / Saisie Manuelle</legend>
        <input type="text" id="parametre-input" placeholder="Tapez un paramètre ou une commande..." />
        <button id="set-param-button">Définir Paramètre</button>
        <button id="run-command-button">Exécuter Commande Manuelle</button>
    </fieldset>
    
    <button id="start-button">Démarrer l'écoute</button>
    <button id="stop-button" disabled>Arrêter l'écoute</button>

    <script>
        // // _ Définition des constantes et des variables globales
        const BASE_URL = 'https://script.google.com/macros/s/AKfycbxXf0XjuRmvIeuptw7zEA8SHwPAo-0rxv8aFoGa20lk1KpbgxupcL7L-FiaAGE_86pI/exec'; 
        // // _ Ceci est un DEPLOY_ID de démo. À REMPLACER par votre ID réel de Apps Script (celui du arrMySheet[0][1]).
        
        let mode = "auto";
        let parametre = "";
        let recognition = null; // Objet pour la reconnaissance vocale

        // // _ Références aux éléments du DOM
        const statusEl = document.getElementById('status');
        const modeDisplayEl = document.getElementById('mode-display');
        const paramDisplayEl = document.getElementById('parametre-display');
        const recognizedTextEl = document.getElementById('recognized-text-display');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const paramInput = document.getElementById('parametre-input');
        const setParamButton = document.getElementById('set-param-button');
        const runCommandButton = document.getElementById('run-command-button');

        // BLOC DE DONNÉES EN DUR (Assurer le succès)
        // -----------------------------------------------------------------------------------
        let commandsData = [   // La liste des commandes sera chargée dynamiquement.
            // // _ baseWords est maintenant un tableau de synonymes.
            {"baseWords": ["liste", "list"], "comandGet": "listAllocine","echec":"paramètre ?"}, 
            {"baseWords": ["choisi", "choisis", "choisit"], "comandGet": "choixAllocine","echec":"paramètre ?"},
            {"baseWords": ["cherche exact"], "comandGet": "findExact","echec":"paramètre ?"},
            {"baseWords": ["cherche"], "comandGet": "find","echec":"paramètre ?"},
            {"baseWords": ["quit", "quitter"], "comandGet": "Quitter","echec":"paramètre ?"},
            {"baseWords": ["identifiant"], "comandGet": "goWSheetIdRow","echec":"paramètre ?"},
            {"baseWords": ["allocine"], "comandGet": "allocine","echec":"paramètre ?"}
        ];
        
        // ________________________DEF__(Fonctions Utilitaires)___________________

        /**
         * Fonction: dire
         * Rôle: Utilise la synthèse vocale pour prononcer un texte.
         * Usage: dire("Bonjour");
         */
        function dire(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            window.speechSynthesis.speak(utterance);
        }

        /**
         * Fonction: noAccents
         * Rôle: Supprime les accents, la ponctuation et met en minuscules.
         * Usage: const sansAccent = noAccents("Liste Pénélope.");
         */
        function noAccents(strIn) {
            // Normalise et supprime les accents, puis retire la ponctuation et les symboles non-lettres/chiffres
            let normalized = strIn.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalized = normalized.replace(/[^a-zA-Z0-9\s]/g, ""); // Retire ponctuation
            return normalized.toLowerCase().trim();
        }

        /**
         * Fonction: updateDisplay
         * Rôle: Met à jour l'affichage des informations clés (mode, paramètre, statut).
         */
        function updateDisplay(newStatus = null) {
            if (newStatus) {
                statusEl.textContent = newStatus;
            }
            modeDisplayEl.textContent = mode;
            paramDisplayEl.textContent = parametre ? parametre : "Non défini";
        }
        
        /**
         * Fonction: loadConfig
         * Rôle: Télécharge la liste des commandes et la configuration depuis Apps Script.
         */
        async function loadConfig() {
            updateDisplay("Chargement de la configuration...");
            const configUrl = `${BASE_URL}?action=getConfig`;
            try{
                if (false){ // pour forcer l'usage du BLOC DE DONNÉES EN DUR (À utiliser pour les tests JS locaux si le fetch échoue)
                    // -----------------------------------------------------------------------------------
                    // // _ BLOC DE DONNÉES DYNAMIQUES (À utiliser si le fetch réussit)
                    const response = await fetch(configUrl); 
                    commandsData = await response.json();
                }
                // NOUVEAU CHECK VISUEL : Ajout d'une classe pour rendre le statut vert
                statusEl.classList.add('success');
                console.log("SUCCESS: Configuration des commandes en dur chargée."); // Vérification Console
                
                updateDisplay("Configuration chargée. Prêt. (Vérifiez si l'affichage est vert)");
                
                // Tente toujours de parler
                dire("Configuration chargée. Prêt."); 
                startButton.disabled = false;

            } catch (error) {
                console.error("Config en dure - Erreur de chargement de la config:", error);
                statusEl.classList.remove('success');
                statusEl.classList.add('error');
                updateDisplay("config en dure _ Erreur: Échec du chargement de la configuration.");
                dire("Config en dure - Erreur: Échec du chargement de la configuration.");
            }
        }
        
        // ________________________DEF__(Fonctions d'Action)___________________

        /**
         * Fonction: sendToAppsScript
         * Rôle: Envoie la commande et le paramètre à l'application Google Apps Script.
         * Points Particuliers: Ajout d'un traitement d'erreur robuste pour diagnostiquer les problèmes réseau/CORS.
         * @param {string} action - L'action (comandGet) à exécuter.
         * @param {string} param1 - Le paramètre de la commande.
         */
        async function sendToAppsScript(action, param1) {
            // // _ Utilise encodeURIComponent pour s'assurer que les espaces et caractères spéciaux sont bien encodés
            const url = `${BASE_URL}?action=${action}&param1=${encodeURIComponent(param1)}`;
            
            console.log(`[Requête Apps Script] Tentative d'envoi: ${url}`);
            updateDisplay(`Envoi de la commande ${action} avec paramètre: ${param1}...`);
            dire("Envoi en cours.");

            try {
                // // _ Lance la requête vers Apps Script
                const response = await fetch(url);
                
                if (response.ok) {
                    // Si le statut est 200 (OK)
                    const resultText = await response.text();
                    updateDisplay(`Réponse reçue: ${resultText}`);
                    dire("Commande exécutée.");
                    console.log(`[Réponse Apps Script] Statut OK. Réponse: ${resultText}`);
                } else {
                    // Si le statut est une erreur HTTP (4xx, 5xx), le Apps Script a répondu mais a échoué.
                    const errorText = await response.text();
                    updateDisplay(`Erreur HTTP: ${response.status} - Apps Script a répondu par une erreur interne. Consultez les logs du script.`);
                    dire("Erreur de connexion Apps Script.");
                    console.error(`[Erreur HTTP Apps Script] Statut: ${response.status}. Corps: ${errorText}`);
                }

            } catch (error) {
                // // _ Cette erreur attrape les problèmes réseau/CORS/Déploiement qui bloquent la requête AVANT qu'elle atteigne le serveur.
                updateDisplay(`ERREUR FATALE CLIENT: Requête bloquée. Vérifiez l'URL de déploiement et le réseau. Détails dans la console.`);
                dire("Erreur de connexion Apps Script.");
                console.error(`[ERREUR FATALE CLIENT] La requête a échoué. Cause la plus probable: mauvaise BASE_URL ou blocage CORS/réseau.`, error);
            }
        }

        // ________________________DEF__(Logique Commande)___________________

        /**
         * Fonction: processCommand
         * Rôle: Gère la logique de la commande vocale (modes, paramètres, exécution).
         * Usage: processCommand("cherche exact titanic");
         */
        function processCommand(phraseBrute) {
            let phrase = noAccents(phraseBrute);
            console.log('SAID (Normalisé):' + phrase);
            recognizedTextEl.textContent = phraseBrute;

            // 1. GESTION DES COMMANDES INTERNES (Mode, Paramètre)
            
            // a. Gestion du Mode
            if (phrase.includes("mode")) {
                let newMode = phrase.includes("direct") ? "direct" :
                              phrase.includes("indirect") ? "indirect" :
                              phrase.includes("auto") ? "auto" : null;
                if (newMode) {
                    mode = newMode;
                    updateDisplay(`Mode changé en ${mode}`);
                    dire(`Mode ${mode}`);
                    return;
                }
            }

            // b. Gestion du Paramètre (pour le mode indirect)
            if (phrase.includes("parametre egal") || phrase.includes("parametre =")) {
                // Recherche tout ce qui vient après le mot "égal" ou "="
                const match = phraseBrute.match(/egal\s*(.*)|=\s*(.*)/);
                if (match && (match[1] || match[2])) {
                    parametre = match[1] ? match[1].trim() : match[2].trim(); // Garde les accents dans le paramètre !
                    updateDisplay(`Paramètre global défini.`);
                    dire(`Paramètre défini: ${parametre}`);
                    return;
                }
            }

            // 2. RECHERCHE ET EXÉCUTION DE LA COMMANDE APPS SCRIPT
            for (const item of commandsData) {
                /*let commandFound = true;
                const baseWords = noAccents(item.baseWord).split(" ");
                let lastWord = baseWords[baseWords.length - 1];

                for (const w of baseWords) {
                    if (!phrase.includes(w)) {
                        commandFound = false;
                        break;
                    }
                }*/


                
                let commandFound = false; // Initialisation à false
                // const baseWords = noAccents(item.baseWord).split(" "); // //// _ ANCIENNE LIGNE SUPPRIMEE
                // let lastWord = baseWords[baseWords.length - 1]; // //// _ ANCIENNE LIGNE SUPPRIMEE
                let lastWord = ""; // _ Nouveau: Stocke le mot-clé réellement trouvé pour l'extraction de paramètre.
                // NOUVEAU: Itération sur les keywords (synonymes/variantes)
                for (const keyword of item.keywords) {
                    const normalizedKeyword = noAccents(keyword).toLowerCase(); // _ S'assurer que le keyword est normalisé
                    
                    // On vérifie si la phrase normalisée commence par le keyword ou l'inclut
                    // L'usage de `startsWith` est généralement plus précis pour une commande au début de la phrase.
                    if (phrase.includes(normalizedKeyword)) { // _ Utilisation de includes pour les commandes composées
                        commandFound = true;
                        lastWord = normalizedKeyword; // _ Le mot-clé trouvé devient la référence pour l'extraction du paramètre
                        break; // Une variante est suffisante
                    }
                }

                
                if (commandFound) {
                    let getAction = item.comandGet;
                    let getParam1 = "";
                    
                    // Si 'quit', pas d'envoi à Apps Script
                    if (getAction === "Quitter") {
                        dire("Au revoir !");
                        recognition.stop();
                        return;
                    }

                    // Extrait le paramètre (ce qui suit le dernier mot de la commande)
                    // On cherche le paramètre dans la PHRASE BRUTE (avec accents) pour le garder intact
                    const indexAfterCommand = phrase.indexOf(lastWord) + lastWord.length;
                    // On trouve l'équivalent dans la phrase brute (c'est une estimation car les longueurs peuvent varier)
                    let paramVoc = phraseBrute.substring(indexAfterCommand).trim(); 

                    // LOGIQUE D'EXÉCUTION
                    const paramIsProvided = paramVoc !== "";

                    if (mode === "auto") {
                        getParam1 = paramIsProvided ? paramVoc : parametre;
                    } else if (mode === "indirect") {
                        getParam1 = parametre; // Toujours utiliser le paramètre global
                    } else if (mode === "direct" && paramIsProvided) {
                        getParam1 = paramVoc; // Utiliser seulement ce qui a été dit
                    }
                    
                    // Vérification finale du paramètre
                    if (getParam1) {
                        sendCommand(getAction, getParam1);
                        return; // Une fois trouvée et exécutée, on sort
                    } else {
                        console.log(item.echec);
                        dire(`Veuillez spécifier un ${item.echec}`);
                        return;
                    }
                }
            }

            // Si aucune commande reconnue
            if (!phrase.includes("mode") && !phrase.includes("parametre")) {
                 dire("Commande non reconnue.");
            }
        }

        // ________________________DEF__(Reconnaissance Vocale)___________________

        /**
         * Fonction: startSpeechRecognition
         * Rôle: Initialise et gère l'écoute vocale.
         */
        function startSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                dire("Désolé, votre navigateur ne supporte pas la reconnaissance vocale.");
                updateDisplay("Non supporté.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = false; // Reconnaissance phrase par phrase
            recognition.interimResults = true;   // ou false pour n'afficher que le texte finalement reconnu

            recognition.onstart = () => {
                startButton.disabled = true;
                stopButton.disabled = false;
                updateDisplay("En écoute... Parlez.");
                console.log("Reconnaissance vocale démarrée.");
            };

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                let phrase = event.results[last][0].transcript;
                processCommand(phrase);
            };

            recognition.onerror = (event) => {
                console.error('Erreur de reconnaissance vocale:', event.error);
                let errorMessage = "Erreur inconnue.";
                
                // Mettre à jour le statut et le message d'erreur
                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    errorMessage = "Accès microphone refusé. (Autorisation nécessaire).";
                    // Erreur critique : on n'essaie pas de redémarrer
                    stopButton.disabled = true;
                    startButton.disabled = false;
                } else if (event.error === 'no-speech') {
                    errorMessage = "Rien entendu. (Parlez plus fort ou plus près).";
                } else if (event.error === 'audio-capture') {
                    errorMessage = "Erreur de capture audio. (Micro occupé ?).";
                } else if (event.error === 'network') {
                    errorMessage = "Erreur réseau. (Connexion instable ?).";
                }
                updateDisplay(errorMessage);

                // Si ce n'est pas une erreur de permission, on peut laisser le onend redémarrer l'écoute
                // ou forcer un redémarrage si l'écoute est continue.
                // Dans notre cas (continuous=false), le onend va se charger de relancer,
                // sauf si l'erreur est critique (permission).
            };

            recognition.onend = () => {
                if (stopButton.disabled === false) {
                     // Si l'écoute n'a pas été stoppée manuellement, on relance
                    recognition.start();
                } else {
                    updateDisplay("Prêt.");
                }
            };
            
            recognition.start();
            dire("Je vous écoute.");
        }

        // ________________________MAIN___________________

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialisation
            loadConfig(); 

            // 2. Événements pour la reconnaissance vocale
            startButton.addEventListener('click', startSpeechRecognition);
            stopButton.addEventListener('click', () => {
                if (recognition) {
                    recognition.stop();
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    updateDisplay("Écoute arrêtée.");
                }
            });

            // 3. Événements pour la saisie manuelle (Correction)
            setParamButton.addEventListener('click', () => {
                const newParam = paramInput.value.trim();
                if (newParam) {
                    parametre = newParam;
                    updateDisplay("Paramètre global mis à jour manuellement.");
                    paramInput.value = "";
                    dire("Paramètre mis à jour.");
                }
            });

            // 4. Exécution manuelle d'une commande complète
            runCommandButton.addEventListener('click', () => {
                const manualCommand = paramInput.value.trim();
                if (manualCommand) {
                    processCommand(manualCommand);
                    paramInput.value = "";
                }
            });
        });
    </script>
</body>
</html>
